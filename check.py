import pandas as pd
from pathlib import Path
import time
import os

# Clear console for cleaner output
os.system('cls' if os.name == 'nt' else 'clear')

# Paths to CSV files
parser_csv_path = Path("output_icici.csv")       # CSV generated by your parser
reference_csv_path = Path("data/icici/icici_expected.csv")  # Ground truth CSV

# Header box
print("â•”" + "â•" * 58 + "â•—")
print("â•‘ ğŸ•’  Preparing to check and validate your parser output...        â•‘")
print("â•š" + "â•" * 58 + "â•\n")

# Validation checklist box
print("ğŸ“‹ Validation Plan:")
print("â•”" + "â•" * 40 + "â•—")
print("â•‘ 1ï¸âƒ£ Columns â€” names and order match           â•‘")
print("â•‘ 2ï¸âƒ£ Rows â€” same number of entries              â•‘")
print("â•‘ 3ï¸âƒ£ Data types â€” consistency across both files â•‘")
print("â•‘ 4ï¸âƒ£ Values â€” each cell matches exactly         â•‘")
print("â•š" + "â•" * 40 + "â•\n")

# 2-second countdown
for i in range(2, 0, -1):
    print(f"â³ Starting validation in {i} second(s)...")
    time.sleep(1)

print("\nğŸš€ Validation process started!\n")

# Step 1 â€” Load CSVs
print("â•”" + "â•" * 60 + "â•—")
print("â•‘ ğŸ” Step 1: Loading CSV files...                                â•‘")
print("â•š" + "â•" * 60 + "â•")

df_parser = pd.read_csv(parser_csv_path)
df_reference = pd.read_csv(reference_csv_path)

print(f"âœ… Loaded parser CSV: {parser_csv_path} ({len(df_parser)} rows, {len(df_parser.columns)} columns)")
print(f"âœ… Loaded reference CSV: {reference_csv_path} ({len(df_reference)} rows, {len(df_reference.columns)} columns)\n")

# Step 2 â€” Structure validation
print("â•”" + "â•" * 60 + "â•—")
print("â•‘ ğŸ” Step 2: Checking basic structure validation...               â•‘")
print("â•š" + "â•" * 60 + "â•")

if list(df_parser.columns) == list(df_reference.columns):
    print("âœ… Column names match exactly.")
else:
    print("âŒ Column names do NOT match.")
    print("   Parser columns:", list(df_parser.columns))
    print("   Reference columns:", list(df_reference.columns))

if len(df_parser) == len(df_reference):
    print("âœ… Row counts match.")
else:
    print(f"âŒ Row counts differ. Parser: {len(df_parser)}, Reference: {len(df_reference)}")

# Step 3 â€” Dtype consistency
print("\nâ•”" + "â•" * 60 + "â•—")
print("â•‘ ğŸ” Step 3: Checking data type consistency...                    â•‘")
print("â•š" + "â•" * 60 + "â•")

parser_dtypes = df_parser.dtypes.to_dict()
reference_dtypes = df_reference.dtypes.to_dict()
for col in df_reference.columns:
    if parser_dtypes.get(col) == reference_dtypes.get(col):
        print(f"   âœ… {col}: dtype matches ({parser_dtypes[col]})")
    else:
        print(f"   âŒ {col}: dtype mismatch (Parser: {parser_dtypes.get(col)}, Reference: {reference_dtypes.get(col)})")

# Step 4 â€” Full equality
print("\nâ•”" + "â•" * 60 + "â•—")
print("â•‘ ğŸ” Step 4: Checking full DataFrame equality...                  â•‘")
print("â•š" + "â•" * 60 + "â•")

if df_parser.equals(df_reference):
    print("âœ… Parser output matches the reference CSV exactly!")
else:
    print("âŒ Parser output does NOT match the reference CSV.")

    print("\nâ•”" + "â•" * 60 + "â•—")
    print("â•‘ ğŸ” Step 5: Showing cell-level differences...                    â•‘")
    print("â•š" + "â•" * 60 + "â•")

    try:
        comparison_df = df_parser.compare(df_reference)
        print(comparison_df)
        comparison_df.to_csv("csv_differences.csv")
        print("\nğŸ’¾ Differences saved to csv_differences.csv for review.")
    except ValueError as e:
        print(f"âš ï¸ Unable to compare directly (possible shape mismatch): {e}")

# Done
print("\nâ•”" + "â•" * 58 + "â•—")
print("â•‘ âœ… Validation complete.                                         â•‘")
print("â•š" + "â•" * 58 + "â•")
